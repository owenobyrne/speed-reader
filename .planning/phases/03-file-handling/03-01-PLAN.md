---
phase: 03-file-handling
plan: 01
type: execute
---

<objective>
Set up Electron preload/IPC infrastructure and implement drag-drop file handling with PDF and Word document parsing.

Purpose: Enable users to drag-drop PDF and Word files to load them into the RSVP reader.
Output: Working drag-drop zone that accepts .pdf and .docx files, extracts text, and loads into RSVP display.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-file-handling/03-RESEARCH.md

# Prior phase summaries (Phase 3 depends on both):
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/02-core-reader/02-01-SUMMARY.md

# Key files to modify:
@main.js
@index.html
@renderer.js
@styles.css

**Tech stack available:** electron@40
**Established patterns:**
- State object pattern for RSVP: words[], currentIndex, isPlaying, wpm
- displayWord() renders with before/orp/after spans
- play()/pause()/loadText() control playback
- Security defaults: nodeIntegration false, contextIsolation true

**Constraining decisions:**
- Phase 01: contextIsolation: true requires preload script for file access
- Phase 02: loadText(text) function exists and is ready for external input

**From RESEARCH.md:**
- Use pdf-parse for PDF, mammoth for Word docs
- Use preload.js with contextBridge for secure file access
- Parser factory pattern to route by extension
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create preload script and drag-drop zone</name>
  <files>preload.js, main.js, index.html, styles.css</files>
  <action>
1. Create preload.js with contextBridge exposing:
   - readFile(filePath) → returns Buffer
   - getExtension(filePath) → returns lowercase extension
   Use require('fs').readFileSync and require('path').extname

2. Update main.js BrowserWindow webPreferences to add:
   - preload: path.join(__dirname, 'preload.js')

3. Add drag-drop zone to index.html:
   - Create div#drop-zone wrapping the rsvp-container
   - Add instruction text "Drop PDF, Word, or paste URL" (hidden during playback)

4. Add styles.css for drop zone:
   - Full viewport coverage, centered content
   - Visual feedback on dragover (subtle border highlight)
   - Hide instruction text when .playing class present
  </action>
  <verify>npm start launches without errors, drop zone visible</verify>
  <done>Preload script registered, drop zone renders with drag feedback</done>
</task>

<task type="auto">
  <name>Task 2: Install parsing libraries and implement document extraction</name>
  <files>package.json, renderer.js</files>
  <action>
1. Install libraries:
   npm install pdf-parse mammoth

2. In renderer.js, add parser functions (IMPORTANT: these run in renderer with preload access):
   - parsePDF(buffer) - uses pdf-parse, returns text string
   - parseDocx(buffer) - uses mammoth.extractRawText, returns text string

3. Add drag-drop event handlers in renderer.js:
   - dragover: preventDefault, add visual class
   - dragleave: remove visual class
   - drop: preventDefault, get file path from e.dataTransfer.files[0].path
     - Use window.fileAPI.readFile() and window.fileAPI.getExtension()
     - Route to appropriate parser based on extension
     - Call loadText(extractedText) to load into RSVP
     - Call play() to start playback
     - Handle .txt files directly (buffer.toString('utf-8'))

4. Add error handling:
   - Unsupported format: alert user
   - Parse failure: alert user with error message
   - Empty extraction: alert "No text found in document"
  </action>
  <verify>Drop a .pdf file and a .docx file - both should parse and begin RSVP playback</verify>
  <done>PDF and Word files dropped on window extract text and load into RSVP display</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm start runs without errors
- [ ] Drop zone visible with instruction text
- [ ] Dropping .pdf file extracts text and starts RSVP playback
- [ ] Dropping .docx file extracts text and starts RSVP playback
- [ ] Dropping .txt file works
- [ ] Unsupported file type shows error message
</verification>

<success_criteria>

- Preload script created and registered
- Drag-drop zone functional with visual feedback
- PDF text extraction working via pdf-parse
- Word doc extraction working via mammoth
- Extracted text loads into existing RSVP engine
- Error handling for unsupported/empty files
</success_criteria>

<output>
After completion, create `.planning/phases/03-file-handling/03-01-SUMMARY.md`
</output>
