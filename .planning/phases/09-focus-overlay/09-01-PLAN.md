---
phase: 09-focus-overlay
plan: 01
type: execute
---

<objective>
Add fullscreen focus overlay for distraction-free reading.

Purpose: Allow users to hide desktop distractions with a dark backdrop behind the reader window, creating an immersive reading environment.
Output: Toggle-able fullscreen dark overlay behind main window, activated via keyboard shortcut.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./09-01-summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-frameless-window/08-01-SUMMARY.md
@main.js
@renderer.js
@preload.js

**From Phase 8:** Window control IPC pattern established (windowAPI namespace, preload exposes methods, main handles IPC)
**Patterns:** Frameless window with frame:false, IPC via contextBridge
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create backdrop window with toggle IPC</name>
  <files>main.js, preload.js</files>
  <action>
In main.js:
1. Create backdropWindow variable at module scope (null initially)
2. Add createBackdropWindow() function:
   - Creates fullscreen BrowserWindow with transparent:true, frame:false, skipTaskbar:true
   - Sets alwaysOnTop:true with level 'screen-saver' (ensures above desktop, below everything else) - actually use alwaysOnTop:false and manage z-order manually
   - Actually simpler: create maximized window with backgroundColor '#000' (no transparency needed)
   - Window should be non-focusable (focusable:false) so clicking doesn't steal focus from main
   - Position below main window using setAlwaysOnTop levels or explicit z-ordering
   - Load a simple black HTML page or use backgroundColor option
3. Add toggle-focus-overlay IPC handler:
   - If backdropWindow exists and not destroyed: close it, set to null
   - Else: call createBackdropWindow(), then focus main window back
4. Ensure backdrop closes when app quits (cleanup in window-all-closed or before-quit)

In preload.js:
- Add toggleFocusOverlay method to windowAPI that invokes 'toggle-focus-overlay'

Key considerations:
- Use backgroundColor: '#000000' on BrowserWindow config (simpler than loading HTML)
- Set focusable:false so clicks go through to main window
- Main window needs alwaysOnTop:true with higher level to stay above backdrop
- Backdrop uses fullscreen:true for true fullscreen coverage
  </action>
  <verify>App starts without errors, IPC handler registered (check console for registration)</verify>
  <done>Backdrop window creation function exists, toggle IPC handler registered, preload exposes method</done>
</task>

<task type="auto">
  <name>Task 2: Wire up keyboard shortcut and z-ordering</name>
  <files>renderer.js, main.js</files>
  <action>
In renderer.js:
- Add 'o' key handler in keydown listener to call window.windowAPI.toggleFocusOverlay()
- Show brief indicator "Focus Mode" / "Focus Mode Off" using existing speed indicator pattern

In main.js (refine from Task 1 if needed):
- When backdrop shown: set mainWindow.setAlwaysOnTop(true, 'floating')
- When backdrop hidden: set mainWindow.setAlwaysOnTop(false)
- This ensures main window stays above backdrop but returns to normal when overlay off

Edge cases:
- If user closes main window while backdrop is shown, ensure backdrop also closes
- Store reference to mainWindow at module scope for z-order management
  </action>
  <verify>Press 'o' key - backdrop appears behind window. Press 'o' again - backdrop disappears. Window remains interactive throughout.</verify>
  <done>Focus overlay toggles with 'o' key, main window stays above backdrop, indicator shows state</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm start` launches app without errors
- [ ] Press 'o' - dark fullscreen backdrop appears behind main window
- [ ] Main window remains fully interactive (can drag, click controls, type)
- [ ] Press 'o' again - backdrop disappears
- [ ] Desktop visible again after backdrop removed
- [ ] Backdrop covers all monitors or at least primary monitor
- [ ] Closing main window also closes backdrop (no orphan windows)
</verification>

<success_criteria>

- Focus overlay toggles with 'o' key
- Main window stays above backdrop and remains interactive
- Backdrop is non-focusable (clicks don't steal focus)
- Clean cleanup on app exit
- Visual indicator shows focus mode state
</success_criteria>

<output>
After completion, create `.planning/phases/09-focus-overlay/09-01-SUMMARY.md`
</output>
