---
phase: 04-controls-polish
plan: 02
type: execute
---

<objective>
Implement navigation controls (jump sentence/paragraph) and reading position persistence.

Purpose: Allow users to navigate within content and resume reading where they left off.
Output: Arrow key navigation and automatic position saving per document.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan in this phase:
@.planning/phases/04-controls-polish/04-01-SUMMARY.md (will exist when this runs)

# Key files to modify:
@renderer.js
@main.js
@preload.js

**Tech stack available:** electron@40, localStorage (renderer), electron-store or fs (main process)
**Established patterns:** IPC architecture, state object, keyboard handlers from 04-01

**From PROJECT.md:**
- Navigation: jump back sentence, jump back paragraph
- Save and resume reading position per document
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sentence/paragraph navigation</name>
  <files>renderer.js</files>
  <action>
1. Add to state:
   - sourceText: '' (original full text for boundary detection)
   - sourceId: '' (identifier for position saving - filename or URL)

2. Update loadText() to store sourceText and compute sentence/paragraph boundaries:
   - sentenceStarts: array of word indices where sentences begin (after . ! ?)
   - paragraphStarts: array of word indices where paragraphs begin (after double newline in original)

3. Create navigation functions:
   - jumpBackSentence(): find previous sentence start, set currentIndex, display word
   - jumpForwardSentence(): find next sentence start
   - jumpBackParagraph(): find previous paragraph start
   - jumpForwardParagraph(): find next paragraph start

4. Add keyboard handlers:
   - Left Arrow: jump back one sentence (pause if playing)
   - Right Arrow: jump forward one sentence
   - Ctrl+Left: jump back one paragraph
   - Ctrl+Right: jump forward one paragraph

5. When navigating while playing: pause first, then jump, user presses Space to resume
  </action>
  <verify>Load content, press Left/Right arrows - jumps between sentences; Ctrl+arrows jumps paragraphs</verify>
  <done>Arrow keys navigate sentences, Ctrl+arrows navigate paragraphs, pauses playback on navigation</done>
</task>

<task type="auto">
  <name>Task 2: Add position persistence</name>
  <files>renderer.js, preload.js, main.js</files>
  <action>
1. Use localStorage in renderer (simpler than electron-store for this use case):
   - Key format: "reading-position:{sourceId}"
   - sourceId: For files, use filename; for URLs, use URL

2. Update handleDroppedFile and handleURL:
   - Set state.sourceId to filename (from path) or URL
   - After loadText(), check localStorage for saved position
   - If found and valid (< words.length), set currentIndex to saved position

3. Create savePosition() function:
   - Save { index: currentIndex, timestamp: Date.now() } to localStorage
   - Call on pause() and on window beforeunload

4. Add position indicator showing progress:
   - Show "Word X of Y" or percentage at bottom of screen
   - Update on each word advance
   - Style: small, dim text, unobtrusive

5. Add beforeunload handler to save position when closing app
  </action>
  <verify>Load file, read partway, close app, reopen and load same file - resumes from saved position</verify>
  <done>Position saved on pause and close, restored when reopening same document, progress indicator visible</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Navigation controls and position persistence for RSVP reader</what-built>
  <how-to-verify>
    1. Run: npm start
    2. Load a document (PDF or URL with substantial text)
    3. Let it play for 10-20 words, then press Space to pause
    4. Test sentence navigation: Press Left Arrow - should jump back to previous sentence start
    5. Test sentence navigation: Press Right Arrow - should jump forward to next sentence
    6. Test paragraph navigation: Press Ctrl+Left - should jump back a paragraph
    7. Test paragraph navigation: Press Ctrl+Right - should jump forward a paragraph
    8. Confirm: Progress indicator shows "Word X of Y" or similar
    9. Test persistence: Note current position, close the app completely
    10. Reopen app, load the SAME file/URL - should resume from saved position
    11. Test different file: Load a different document - should start from beginning (no saved position)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm start runs without errors
- [ ] Left/Right arrows navigate between sentences
- [ ] Ctrl+Left/Right navigate between paragraphs
- [ ] Position saved on pause and app close
- [ ] Position restored when loading same document
- [ ] Progress indicator shows current position
</verification>

<success_criteria>

- All navigation shortcuts working
- Position persistence working for files and URLs
- Progress indicator visible and accurate
- Phase 4: Controls & Polish complete
- All PROJECT.md keyboard control requirements met
</success_criteria>

<output>
After completion, create `.planning/phases/04-controls-polish/04-02-SUMMARY.md`

Mark Phase 4 complete in ROADMAP.md and STATE.md
</output>
